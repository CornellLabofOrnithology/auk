<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />



<title>auk development</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>
<script>// Hide empty <a> tag within highlighted CodeBlock for screen reader accessibility (see https://github.com/jgm/pandoc/issues/6352#issuecomment-626106786) -->
// v0.0.1
// Written by JooYoung Seo (jooyoung@psu.edu) and Atsushi Yasumoto on June 1st, 2020.

document.addEventListener('DOMContentLoaded', function() {
  const codeList = document.getElementsByClassName("sourceCode");
  for (var i = 0; i < codeList.length; i++) {
    var linkList = codeList[i].getElementsByTagName('a');
    for (var j = 0; j < linkList.length; j++) {
      if (linkList[j].innerHTML === "") {
        linkList[j].setAttribute('aria-hidden', 'true');
      }
    }
  }
});
</script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
      pre > code.sourceCode { white-space: pre; position: relative; }
      pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
      pre > code.sourceCode > span:empty { height: 1.2em; }
      code.sourceCode > span { color: inherit; text-decoration: inherit; }
      div.sourceCode { margin: 1em 0; }
      pre.sourceCode { margin: 0; }
      @media screen {
      div.sourceCode { overflow: auto; }
      }
      @media print {
      pre > code.sourceCode { white-space: pre-wrap; }
      pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
      }
      pre.numberSource code
        { counter-reset: source-line 0; }
      pre.numberSource code > span
        { position: relative; left: -4em; counter-increment: source-line; }
      pre.numberSource code > span > a:first-child::before
        { content: counter(source-line);
          position: relative; left: -1em; text-align: right; vertical-align: baseline;
          border: none; display: inline-block;
          -webkit-touch-callout: none; -webkit-user-select: none;
          -khtml-user-select: none; -moz-user-select: none;
          -ms-user-select: none; user-select: none;
          padding: 0 4px; width: 4em;
          color: #aaaaaa;
        }
      pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
      div.sourceCode
        {   }
      @media screen {
      pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
      }
      code span.al { color: #ff0000; font-weight: bold; } /* Alert */
      code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
      code span.at { color: #7d9029; } /* Attribute */
      code span.bn { color: #40a070; } /* BaseN */
      code span.bu { } /* BuiltIn */
      code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
      code span.ch { color: #4070a0; } /* Char */
      code span.cn { color: #880000; } /* Constant */
      code span.co { color: #60a0b0; font-style: italic; } /* Comment */
      code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
      code span.do { color: #ba2121; font-style: italic; } /* Documentation */
      code span.dt { color: #902000; } /* DataType */
      code span.dv { color: #40a070; } /* DecVal */
      code span.er { color: #ff0000; font-weight: bold; } /* Error */
      code span.ex { } /* Extension */
      code span.fl { color: #40a070; } /* Float */
      code span.fu { color: #06287e; } /* Function */
      code span.im { } /* Import */
      code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
      code span.kw { color: #007020; font-weight: bold; } /* Keyword */
      code span.op { color: #666666; } /* Operator */
      code span.ot { color: #007020; } /* Other */
      code span.pp { color: #bc7a00; } /* Preprocessor */
      code span.sc { color: #4070a0; } /* SpecialChar */
      code span.ss { color: #bb6688; } /* SpecialString */
      code span.st { color: #4070a0; } /* String */
      code span.va { color: #19177c; } /* Variable */
      code span.vs { color: #4070a0; } /* VerbatimString */
      code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
    </style>


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>



<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">auk development</h1>



<p>This vignette describes the process of updating and extending <code>auk</code>. Three topics are covered: updating <code>auk</code> when a new eBird taxonomy is released, extending <code>auk</code> to include new filters, and CRAN submission.</p>
<div id="updating-the-ebird-taxonomy" class="section level2">
<h2>Updating the eBird taxonomy</h2>
<p>The species, and other taxa, available for entry into the eBird database is dependent on the <a href="https://ebird.org/science/the-ebird-taxonomy">eBird taxonomy</a>. Every August, the eBird team updates this taxonomy to reflect name changes splits, merges, new species, or any other changes. Historical eBird records are then updated accordingly and subsequent EBD files reflect this updated taxonomy. The <code>auk</code> package stores a copy of this taxonomy as the data frame <code>ebird_taxonomy</code>, and uses it both for filtering by species (<code>auk_species()</code>) and for taxonomic roll-up (<code>auk_rollup()</code>). Therefore, <code>auk</code> must be updated when a new eBird taxonomy is released. This section described how this is done. It is best to do this after the new taxonomy <strong>and</strong> the new EBD have both been released, otherwise the taxonomy and EBD will be out of sync.</p>
<p>When the eBird taxonomy is updated, the new version can be downloaded from the <a href="https://ebird.org/science/the-ebird-taxonomy">eBird website</a>. The taxonomy can be downloaded in csv or Excel format, <strong>be sure to download the Excel file</strong> because the csv file has character encoding issues. Copy this file to <code>data-raw/</code>. At this point, you should check that this new taxonomy has the same format as the previous file, which will also be in this directory. Ensure that the same columns are present and that they’re named the same.</p>
<p>The file <code>data-raw/ebird-taxonomy.r</code> prepares the taxonomy as a data frame to be stored in the package. Open this file and edit the <code>read_xlsx()</code> call to point to the new file you just downloaded. Run the code, then open the <code>ebird_taxonomy</code> data frame to inspect it and make sure there’s no glaring issues. One potential error that should be investigated is non-ASCII characters. Some common names have accented characters (e.g. Rüppell’s Griffon, Gyps rueppelli), which can cause problems. <code>ebird-taxonomy.r</code> converts these characters to their unaccented equivalents (e.g. Ruppell’s Griffon). Check that this record, or others with accented characters, has been properly converted.</p>
<p>Next, update <code>auk_version_date()</code> (<code>R/auk-version-date.r</code>) to reflect the date of the new taxonomy and the new EBD.</p>
<p>Finally, build the package (<code>devtools::build()</code>) and run <code>R CMD check</code> (<code>devtools::check()</code>). If everything looks good, commit to git and push to GitHub.</p>
</div>
<div id="adding-new-filters" class="section level2">
<h2>Adding new filters</h2>
<p>The primary functionality of <code>auk</code> is to apply filters to the EBD to extract a subset of records that can be imported into R and further analyzed. Individual filters are defined by a particular function (e.g. <code>auk_date()</code> or <code>auk_country()</code>) and correspond to subsetting on a particular column (e.g. “OBSERVATION DATE” and “COUNTRY CODE”, respectively). Defining a new filter is a fairly complicated process, involving carefully updating many components of the package, and should only be attempted by experienced R programmers. To add a filter called <code>color</code>, the following steps are required:</p>
<ol style="list-style-type: decimal">
<li>Update <code>auk_ebd()</code> (in file <code>R/auk-ebd.r</code>) to define the column number for the new filter, create a placeholder in the <code>auk_ebd</code> object to store the filtering criteria, and update the <code>auk_ebd</code> print method for the new filter.</li>
<li>Create a new function <code>auk_color()</code> (in file <code>R/auk-color.r</code>) that defines the new filter. As a starting point, use one of the other filtering functions. For example to filter on a range of numeric values, start with <code>auk_duration()</code>, to filter on a logical (true/false) variable use <code>auk_complete()</code>, or to filter on a discrete, categorical variable use <code>auk_country()</code>. Be sure to apply extensive checking on the validity of inputs and update the documentation, including examples.</li>
<li>Update <code>auk_filter()</code> (in file <code>R/auk-filter.r</code>) to incorporate the filtering criteria into the AWK script. Again, use an existing filter as a template.</li>
<li>Create unit tests for the new filter by creating a new <code>test_that()</code> block in <code>tests/testthat/test_filters.r</code>. Again, use an existing filter as a template.</li>
<li>Update <code>README.md</code> and <code>vignettes/auk.Rmd</code> to add the new filter to the list of potential filters.</li>
<li>Build, test, check, and push to GitHub</li>
</ol>
<div id="update-auk_ebd" class="section level3">
<h3>1. Update <code>auk_ebd()</code></h3>
<p>Near the top of the code for <code>auk_ebd()</code>, a data frame named <code>filter_cols</code> is defined which specifies which columns have associated filters. Add a new row to this data frame and set <code>name</code> as the name of the column in the file header that will be filtered on and <code>id</code> as the name of the filter. For example, if you’re creating a filter called <code>auk_color()</code> that filters on the column “FEATHER COLOR”, then set <code>id = &quot;color&quot;</code> and <code>name = &quot;feather color&quot;</code>. Ideally, similar filters should be grouped together in this data frame, so insert the new row accordingly.</p>
<p>For filters that don’t apply to the sampling event data file, i.e. filters at the species level rather than the checklist level, add the id to the character vector <code>not_in_sampling</code>. For example, modify the code to read: <code>not_in_sampling &lt;- c(&quot;species&quot;, &quot;breeding&quot;, &quot;color&quot;)</code>.</p>
<p>Next, at the end of the code for <code>auk_ebd()</code>, the <code>auk_ebd</code> object is created and returned with the statement beginning with <code>structure(...</code>. This object should have placeholders for every filter. So, add a new element to the list, naming the variable after the <code>id</code> in the above data frame, putting it in the same order as in the above data frame, and choosing a sensible data type. For example, if <code>color</code> is a categorical variable, add a new list element <code>color = character()</code>, and if it’s a numeric variable, add <code>color = numeric()</code>.</p>
<p>Finally, within <code>auk-ebd.r</code> a <code>print.auk_ebd()</code> method is defined, which you’ll need to update to print the filter in a sensible way. Here you’re best to find another filter with a similar format and use that as a template. Again, be sure to put the print code for the filter in the right order. For example, for a categorical filter allow multiple potential values, you may way something like:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="co"># color filter</span></span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="kw">cat</span>(<span class="st">&quot;  Feather color: &quot;</span>)</span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="cf">if</span> (<span class="kw">length</span>(x<span class="op">$</span>filters<span class="op">$</span>color) <span class="op">==</span><span class="st"> </span><span class="dv">0</span>) {</span>
<span id="cb1-4"><a href="#cb1-4"></a>  <span class="kw">cat</span>(<span class="st">&quot;all&quot;</span>)</span>
<span id="cb1-5"><a href="#cb1-5"></a>} <span class="cf">else</span> {</span>
<span id="cb1-6"><a href="#cb1-6"></a>  <span class="kw">cat</span>(<span class="kw">paste</span>(x<span class="op">$</span>filters<span class="op">$</span>color, <span class="dt">collapse =</span> <span class="st">&quot;, &quot;</span>))</span>
<span id="cb1-7"><a href="#cb1-7"></a>}</span>
<span id="cb1-8"><a href="#cb1-8"></a><span class="kw">cat</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>)</span></code></pre></div>
</div>
<div id="create-filter-function" class="section level3">
<h3>2. Create filter function</h3>
<p>Create a new function that will allow users to define a filter. Be sure to following the naming conventions used, for our color example, the function should be named <code>auk_color()</code> and it should be in a file called <code>auk-color.r</code>. It’s easiest to use an existing function as a template here. In general, the function should take two argument, the <code>auk_ebd</code> object to modify, and an argument with the filter criteria, e.g. <code>auk_color(x, color)</code>. Note how the name of the function matches the name of the second argument. The function should be edited to include the following:</p>
<ol style="list-style-type: decimal">
<li>Extensive checks on the incoming arguments. Remember that filtering with AWK takes multiple hours, so it’s best to catch any errors early, prior to running <code>auk_filter()</code>. At the very least, check data types and, where possible, check that values are valid (e.g. <code>color</code> should be in <code>c(&quot;red&quot;, &quot;green&quot;, &quot;blue&quot;, ...)</code>). Provide informative error or warning messages where appropriate.</li>
<li>Setting the filter criteria in the <code>auk_ebd</code> object. This is generally as simple as <code>x$filters$color = color</code>.</li>
<li>Thorough documentation. Document all the arguments and provide examples with and without the pipe operator (<code>%&gt;%</code>).</li>
</ol>
</div>
<div id="update-auk_filter" class="section level3">
<h3>3. Update <code>auk_filter()</code></h3>
<p>The actual work of filtering is done by <code>auk_filter()</code>, which generates an AWK script, then calls AWK. This function must be updated to parse the filters defined using the function you created in step 2 into AWK code. In the code for <code>auk_filter()</code>, there are two calls to the internal function <code>awk_translate()</code>, which is an internal function defined in the same file. It’s <code>awk_translate()</code> that you’ll need to edit. This function has a series of code blocks each of which prepares the AWK code for a different filter. Find an existing filter that is similar to the new one you’re creating and copy it over to the correct spot (remember to preserve the ordering of the filters). For the <code>auk_color()</code> example, the code chunk would look like:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a>  <span class="co"># color filter</span></span>
<span id="cb2-2"><a href="#cb2-2"></a>  <span class="cf">if</span> (<span class="kw">length</span>(filters<span class="op">$</span>color) <span class="op">==</span><span class="st"> </span><span class="dv">0</span>) {</span>
<span id="cb2-3"><a href="#cb2-3"></a>    filter_strings<span class="op">$</span>color &lt;-<span class="st"> &quot;&quot;</span></span>
<span id="cb2-4"><a href="#cb2-4"></a>  } <span class="cf">else</span> {</span>
<span id="cb2-5"><a href="#cb2-5"></a>    idx &lt;-<span class="st"> </span>col_idx<span class="op">$</span>index[col_idx<span class="op">$</span>id <span class="op">==</span><span class="st"> &quot;color&quot;</span>]</span>
<span id="cb2-6"><a href="#cb2-6"></a>    condition &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;$&quot;</span>, idx, <span class="st">&quot; == </span><span class="ch">\&quot;</span><span class="st">&quot;</span>, filters<span class="op">$</span>color, <span class="st">&quot;</span><span class="ch">\&quot;</span><span class="st">&quot;</span>,</span>
<span id="cb2-7"><a href="#cb2-7"></a>                        <span class="dt">collapse =</span> <span class="st">&quot; || &quot;</span>)</span>
<span id="cb2-8"><a href="#cb2-8"></a>    filter_strings<span class="op">$</span>color &lt;-<span class="st"> </span><span class="kw">str_interp</span>(awk_if, <span class="kw">list</span>(<span class="dt">condition =</span> condition))</span>
<span id="cb2-9"><a href="#cb2-9"></a>  }</span></code></pre></div>
<p>When given a sampling event data file in addition to a EBD file, <code>auk_filter()</code> will filter both files. By default <code>auk_filter()</code> will apply all filters to both files, however, some filters (e.g. species) are only appropriate for the EBD. To address this, prior to calling <code>auk_translate()</code> for the sampling data, reset the species-specific filters. In the case of color, which is a species specific variable, modify the code as follows:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a>s_filters &lt;-<span class="st"> </span>x<span class="op">$</span>filters</span>
<span id="cb3-2"><a href="#cb3-2"></a>s_filters<span class="op">$</span>species &lt;-<span class="st"> </span><span class="kw">character</span>()</span>
<span id="cb3-3"><a href="#cb3-3"></a><span class="co">## ADD THIS LINE</span></span>
<span id="cb3-4"><a href="#cb3-4"></a>s_filters<span class="op">$</span>color &lt;-<span class="st"> </span><span class="kw">character</span>()</span>
<span id="cb3-5"><a href="#cb3-5"></a><span class="co">##</span></span>
<span id="cb3-6"><a href="#cb3-6"></a>awk_script_sampling &lt;-<span class="st"> </span><span class="kw">awk_translate</span>(<span class="dt">filters =</span> s_filters,</span>
<span id="cb3-7"><a href="#cb3-7"></a>                                     <span class="dt">col_idx =</span> x<span class="op">$</span>col_idx_sampling,</span>
<span id="cb3-8"><a href="#cb3-8"></a>                                     <span class="dt">sep =</span> sep,</span>
<span id="cb3-9"><a href="#cb3-9"></a>                                     <span class="dt">select =</span> select_cols)</span></code></pre></div>
<p>Finally, at the end of the <code>auk-filter.r</code> file, there’s a string named <code>awk_filter</code>, which defines the template for the AWK script. Each filter has a line in this string (e.g. <code>${species}</code>) where the AWK code will be inserted. You’ll need to add a line in this file for your new filter: <code>${color}</code>.</p>
</div>
<div id="unit-tests" class="section level3">
<h3>4. Unit tests</h3>
<p>Now that you’ve successfully created the filter, play around with it a bit to make sure it works as expected. Once you feel the filter is working, it’s time to formalize this testing process by defining unit tests. Open the file <code>tests/testthat/test_filters.r</code> and you’ll notice a series of calls like <code>test_that(&quot;auk_species&quot;, ...</code>, each of which contains tests for a specific filter.</p>
<p>Using an existing test block as an example, define a new block (again, put it in the correct order relative to the other filters). Consult the <a href="https://r-pkgs.org/tests.html">Testing chapter</a> of Hadley Wickham’s <a href="https://r-pkgs.org/">R packages book</a> for details on defining good unit tests. At the very least, define tests to make sure that typical use works as expected, that errors are caught when input is invalid, and that edge cases are correctly handled.</p>
</div>
<div id="update-vignette-and-readme" class="section level3">
<h3>5. Update vignette and README</h3>
<p>Both the vignette (<code>vignettes/auk.Rmd</code>) and README (<code>README.Rmd</code>) have sections giving a short description of each filter. Add the new filter you’ve created here.</p>
</div>
<div id="build-test-check-and-push-to-github" class="section level3">
<h3>6. Build, test, check, and push to GitHub</h3>
<p>Carry out the following final steps:</p>
<ol style="list-style-type: decimal">
<li>Run <code>devtools::document()</code> to generate package documentation</li>
<li>Run <code>devtools::build()</code> to build and install the package</li>
<li>Run <code>devtools::check()</code> to run the units tests and variety of other checks via <code>R CMD check</code></li>
<li>Build the vignettes with <code>devtools::build_vignettes()</code></li>
<li>Build the package website with <code>pkgdown::build_site()</code></li>
<li>Commit to git, then push to GitHub</li>
</ol>
</div>
</div>
<div id="cran-submission" class="section level2">
<h2>CRAN submission</h2>
<p>Minor updates to <code>auk</code> can be pushed to GitHub giving users the option of installing the development version from there. However, at least once a year, when a new eBird taxonomy is released, a new version of <code>auk</code> should be released on CRAN. For full details on this process, consult Hadley Wickham’s <a href="https://r-pkgs.org/release.html">R Packages book</a>, however, I’ll provide a quick guide here. Once The package has been updated following the instructions from the above sections:</p>
<ol style="list-style-type: decimal">
<li>Check the package. Run <code>devtools::check()</code> to run <code>R CMD check</code> locally. Check that a Windows binary can be built by running <code>devtools::build_win()</code>. The results will be emailed to you within about 30 minutes. Also, this package uses continuous integration to automatically check the package on Linux, Mac, and Windows whenever it’s pushed to GitHub. Check the badges at the top of the GitHub repo to ensure the builds are passing. Any NOTEs, ERRORs, or WARNINGs returned by R CMD check must be fixed before submission to CRAN.</li>
<li>Increment the version number in the <code>DESCRIPTION</code> file.</li>
<li>Update <code>NEWS.md</code> to note any new features or changes.</li>
<li>Build the package with <code>devtools::build()</code>, the vignettes with <code>devtools::build_vignettes()</code>, and the website with <code>pkgdown::build_site()</code>.</li>
<li>Commit to git and push to GitHub.</li>
<li>Submit to CRAN with <code>devtools::release()</code></li>
</ol>
<p>At this point, you’ll need to wait for binaries of your package to build, which could take a couple days. It’s possible that problems will arise during this process and your package will be rejected, in which case, you’ll need to fix any problems and resubmit.</p>
<p>Once the package is on CRAN, create a new release on GitHub and tag it with the version number.</p>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
