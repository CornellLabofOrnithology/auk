<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>auk development • auk</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">auk</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/auk.html">Vignette</a>
</li>
<li>
  <a href="../reference/index.html">Function Reference</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/CornellLabofOrnithology/auk">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>auk development</h1>
            
          </div>

    
    
<div class="contents">
<p>This vignette describes the process of updating and extending <code>auk</code>. Two topics are covered: updating <code>auk</code> when a new eBird taxonomy is released and extending <code>auk</code> to include new filters.</p>
<div id="updating-the-ebird-taxonomy" class="section level2">
<h2 class="hasAnchor">
<a href="#updating-the-ebird-taxonomy" class="anchor"></a>Updating the eBird taxonomy</h2>
</div>
<div id="adding-new-filters" class="section level2">
<h2 class="hasAnchor">
<a href="#adding-new-filters" class="anchor"></a>Adding new filters</h2>
<p>The primary functionality of <code>auk</code> is to apply filters to the EBD to extract a subset of records that can be imported into R and further analyzed. Individual filters are defined by a particular function (e.g. <code><a href="../reference/auk_date.html">auk_date()</a></code> or <code><a href="../reference/auk_country.html">auk_country()</a></code>) and correspond to subsetting on a particular column (e.g. “OBSERVATION DATE” and “COUNTRY CODE”, respectively). Defining a new filter is a fairly complicated process, involving carefully updating many components of the package, and should only be attempted by experienced R programmers. To add a filter called <code>color</code>, the following steps are required:</p>
<ol style="list-style-type: decimal">
<li>Update <code><a href="../reference/auk_ebd.html">auk_ebd()</a></code> (in file <code>R/auk-ebd.r</code>) to define the column number for the new filter, create a placeholder in the <code>auk_ebd</code> object to store the filtering criteria, and update the <code>auk_ebd</code> print method for the new filter.</li>
<li>Create a new function <code>auk_color()</code> (in file <code>R/auk-color.r</code>) that defines the new filter. As a starting point, use one of the other filtering functions. For example to filter on a range of numeric values, start with <code><a href="../reference/auk_duration.html">auk_duration()</a></code>, to filter on a logical (true/false) variable use <code><a href="../reference/auk_complete.html">auk_complete()</a></code>, or to filter on a discrete, categorical variable use <code><a href="../reference/auk_country.html">auk_country()</a></code>. Be sure to apply extensive checking on the validity of inputs and update the documentation, including examples.</li>
<li>Update <code><a href="../reference/auk_filter.html">auk_filter()</a></code> (in file <code>R/auk-filter.r</code>) to incorporate the filtering criteria into the AWK script. Again, use an existing filter as a template.</li>
<li>Create unit tests for the new filter by creating a new <code>test_that()</code> block in <code>tests/testthat/test_filters.r</code>. Again, use an existing filter as a template.</li>
<li>Update <code>README.md</code> and <code>vignettes/auk.Rmd</code> to add the new filter to the list of potential filtes.</li>
<li>Build, test, check, and push to GitHub</li>
</ol>
<div id="update-auk_ebd" class="section level3">
<h3 class="hasAnchor">
<a href="#update-auk_ebd" class="anchor"></a>1. Update <code><a href="../reference/auk_ebd.html">auk_ebd()</a></code>
</h3>
<p>Near the top of the code for <code><a href="../reference/auk_ebd.html">auk_ebd()</a></code>, a data frames named <code>filter_cols</code> is defined which specifies which columns have associated filters. Add a new row to this data frame and set <code>name</code> as the name of the column in the file header that will be filtered on and <code>id</code> as the name of the filter. For example, if you’re creating a filter called <code>auk_color()</code> that filters on the column “FEATHER COLOR”, then set <code>id = "color"</code> and <code>name = "feather color"</code>. Ideally, similar filters should be grouped together in this data frame, so insert the new row accordingly.</p>
<p>Next, at the end of the code for <code><a href="../reference/auk_ebd.html">auk_ebd()</a></code>, the <code>auk_ebd</code> object is created and returned with the statement beginning with <code>structure(...</code>. This object should have placeholders for every filter. So, add a new element to the list, naming the variable after the <code>id</code> in the above data frame, putting it in the same order as in the above data frame, and choosing a sensible data type. For example, if <code>color</code> is a categorical variable, add a new list element <code>color = character()</code>, and if it is a logical (T/F) variable, add <code>color = logical()</code>.</p>
<p>Finally, within <code>auk-ebd.r</code> a <code>print.auk_ebd()</code> method is defined, which you’ll need to update to print the filter in a sensible way. Here you’re best to find another filter with a similar format and use that as a template. Again, be sure to put the print code for the filter in the right order. For example, for a categorical filter allow multiple potential values, you may way something like:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># color filter</span>
<span class="kw">cat</span>(<span class="st">"  Feather color: "</span>)
<span class="cf">if</span> (<span class="kw">length</span>(x<span class="op">$</span>filters<span class="op">$</span>species) <span class="op">==</span><span class="st"> </span><span class="dv">0</span>) {
  <span class="kw">cat</span>(<span class="st">"all"</span>)
} <span class="cf">else</span> {
  <span class="kw">cat</span>(<span class="kw">paste</span>(x<span class="op">$</span>filters<span class="op">$</span>color, <span class="dt">collapse =</span> <span class="st">", "</span>))
}
<span class="kw">cat</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span>)</code></pre></div>
</div>
<div id="create-filter-function" class="section level3">
<h3 class="hasAnchor">
<a href="#create-filter-function" class="anchor"></a>2. Create filter function</h3>
<p>Create a new function that will allow users to define a filter. Be sure to following the naming conventions used, for our color example, the function should be named <code>auk_color()</code> and it should be in a file called <code>auk-color.r</code>. It’s easiest to use an existing function as a template here. In general, the function should take two argument, the <code>auk_ebd</code> object to modify, and an argument with the filter criteria, e.g. <code>auk_color(x, color)</code>. Note how the name of the function matches the name of the second argument. The function should be edited to include the following:</p>
<ol style="list-style-type: decimal">
<li>Extensive checks on the incoming arguments. Remember that filtering with AWK takes multiple hours, so it’s best to catch any errors early, prior to running <code><a href="../reference/auk_filter.html">auk_filter()</a></code>. At the very least, check data types and, where possible, check that values are valid (e.g. <code>color</code> should be in <code>c("red", "green", "blue", ...)</code>). Provide informative error or warning messages where appropriate.</li>
<li>Setting the filter criteria in the <code>auk_ebd</code> object. This is generally as simple as <code>x$filters$color = color</code>.</li>
<li>Thorough documentation. Document all the arguments and provide examples with and without the pipe operator (<code>%&gt;%</code>).</li>
</ol>
</div>
<div id="update-auk_filter" class="section level3">
<h3 class="hasAnchor">
<a href="#update-auk_filter" class="anchor"></a>3. Update <code><a href="../reference/auk_filter.html">auk_filter()</a></code>
</h3>
<p>The actual work of filtering is done by <code><a href="../reference/auk_filter.html">auk_filter()</a></code>, which generates an AWK script, then calls AWK. This function must be updated to parse the filters defined using the function you created in 2 into AWK code. In the code for <code><a href="../reference/auk_filter.html">auk_filter()</a></code>, there are two calls to the internal function <code>awk_translate()</code>, which is an internal function defined in the same file. It’s <code>awk_translate()</code> that you’ll need to edit. This function has a series of code blocks each of which prepares the AWK code for a different filter. Find an existing filter that is similar to the new one you’re creating and copy it over to the correct spot (remember to preserve the ordering of the filters). For the <code>auk_color()</code> example, the code chunk would look like:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">  <span class="co"># color filter</span>
  <span class="cf">if</span> (<span class="kw">length</span>(filters<span class="op">$</span>color) <span class="op">==</span><span class="st"> </span><span class="dv">0</span>) {
    filter_strings<span class="op">$</span>color &lt;-<span class="st"> ""</span>
  } <span class="cf">else</span> {
    idx &lt;-<span class="st"> </span>col_idx<span class="op">$</span>index[col_idx<span class="op">$</span>id <span class="op">==</span><span class="st"> "color"</span>]
    condition &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">"$"</span>, idx, <span class="st">" == </span><span class="ch">\"</span><span class="st">"</span>, filters<span class="op">$</span>color, <span class="st">"</span><span class="ch">\"</span><span class="st">"</span>,
                        <span class="dt">collapse =</span> <span class="st">" || "</span>)
    filter_strings<span class="op">$</span>color &lt;-<span class="st"> </span><span class="kw">str_interp</span>(awk_if, <span class="kw">list</span>(<span class="dt">condition =</span> condition))
  }</code></pre></div>
<p>When given a sampling event data file in addition to a EBD file, <code><a href="../reference/auk_filter.html">auk_filter()</a></code> will filter both files. By default <code><a href="../reference/auk_filter.html">auk_filter()</a></code> will apply all filters to both files, however, some filters (e.g. species) are only appropriate for the EBD. To address this, prior to calling <code>auk_translate()</code> for the sampling data, reset the species-specific filters. In the case of color, which is a species specific variable, modify the code as follows:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">s_filters &lt;-<span class="st"> </span>x<span class="op">$</span>filters
s_filters<span class="op">$</span>species &lt;-<span class="st"> </span><span class="kw">character</span>()
## ADD THIS LINE
s_filters<span class="op">$</span>color &lt;-<span class="st"> </span><span class="kw">character</span>()
##
awk_script_sampling &lt;-<span class="st"> </span><span class="kw">awk_translate</span>(<span class="dt">filters =</span> s_filters,
                                     <span class="dt">col_idx =</span> x<span class="op">$</span>col_idx_sampling,
                                     <span class="dt">sep =</span> sep,
                                     <span class="dt">select =</span> select_cols)</code></pre></div>
<p>Finally, at the end of the <code>auk-filter.r</code> file, there’s a string named <code>awk_filter</code>, which defines the template for the AWK script. Each filter has a line in this string (e.g. <code>${species}</code>) where the AWK code will be inserted. You’ll need to add a line in this file for your new filter: <code>${color}</code>.</p>
</div>
<div id="unit-tests" class="section level3">
<h3 class="hasAnchor">
<a href="#unit-tests" class="anchor"></a>4. Unit tests</h3>
<p>Now that you’ve successfully created the filter, play around with it a bit to make sure it works as expected. Once you feel the filter is working, it’s time to formalize this testing process by defining unit tests. Open the file <code>tests/testthat/test_filters.r</code> and you’ll notice a series of calls like <code>test_that("auk_species", ...</code>, each of which contains tests for a specific filter.</p>
<p>Usinging an existing test block as an example, define a new block (again, put it in the correct order relative to the other filters). Consult the <a href="http://r-pkgs.had.co.nz/tests.html">Testing chapter</a> of Hadley Wickham’s <a href="http://r-pkgs.had.co.nz/">R packages book</a> for details on defining good unit tests. At the very least, define tests to make sure that typical use works as expected, that errors are caught when input is invalid, and that edge cases are correctly handled.</p>
</div>
<div id="update-vignette-and-readme" class="section level3">
<h3 class="hasAnchor">
<a href="#update-vignette-and-readme" class="anchor"></a>5. Update vignette and README</h3>
<p>Both the vignette (<code>vignettes/auk.Rmd</code>) and README (<code>README.Rmd</code>) have sections giving a short description of each filter. Add the new filter you’ve created here.</p>
</div>
<div id="build-test-check-and-push-to-github" class="section level3">
<h3 class="hasAnchor">
<a href="#build-test-check-and-push-to-github" class="anchor"></a>6. Build, test, check, and push to GitHub</h3>
<p>Carrry out the following final steps:</p>
<ol style="list-style-type: decimal">
<li>Run <code>devtools::document()</code> to generate package documentation</li>
<li>Run <code>devtools::build()</code> to build and install the package</li>
<li>Run <code>devtools::check()</code> to run the units tests and variety of other checks via <code>R CMD check</code>
</li>
<li>Build the vignettes with <code>devtools::build_vignettes()</code>
</li>
<li>Build the package website with <code>pkgdown::build_site()</code>
</li>
<li>Commit to git, then push to GitHub</li>
</ol>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#updating-the-ebird-taxonomy">Updating the eBird taxonomy</a></li>
      <li><a href="#adding-new-filters">Adding new filters</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by <a href="http://strimas.com">Matthew Strimas-Mackey</a>, <a href="http://eliotmiller.weebly.com/">Eliot Miller</a>, Wesley Hochachka.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
